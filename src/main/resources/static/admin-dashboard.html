<!DOCTYPE html>
<html>
<head>
<title>Admin Dashboard - ParkWave</title>
<style>
body { font-family:Arial; background:#f4f6f8; padding:20px; margin:0; }
.header { background:#e74c3c; color:white; padding:20px; display:flex; justify-content:space-between; align-items:center; }
.header h1 { margin:0; }
.logout-btn { background:white; color:#e74c3c; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; }
.container { max-width:1200px; margin:0 auto; }
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin:20px 0; }
.stat-card { background:white; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); text-align:center; }
.stat-number { font-size:36px; font-weight:bold; color:#e74c3c; }
.stat-label { color:#666; margin-top:10px; }
.tabs { display:flex; gap:10px; margin:20px 0; }
.tab { background:#3498db; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; }
.tab.active { background:#2980b9; }
.tab-content { background:white; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
.table { width:100%; border-collapse:collapse; }
.table th, .table td { padding:12px; text-align:left; border-bottom:1px solid #ddd; }
.table th { background:#f8f9fa; }
.btn { padding:8px 16px; border:none; border-radius:4px; cursor:pointer; }
.btn-primary { background:#3498db; color:white; }
.btn-danger { background:#e74c3c; color:white; }
.btn-success { background:#2ecc71; color:white; }
.form-group { margin-bottom:15px; }
.form-group label { display:block; margin-bottom:5px; }
.form-group input, .form-group select { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; }
.modal-content { background:white; padding:20px; border-radius:8px; max-width:500px; margin:50px auto; }
.close { float:right; font-size:24px; cursor:pointer; }
</style>
</head>
<body>

<div class="header">
<h1>Admin Dashboard</h1>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="container">
<div class="stats-grid">
<div class="stat-card">
<div class="stat-number" id="totalMalls">5</div>
<div class="stat-label">Total Malls</div>
</div>
<div class="stat-card">
<div class="stat-number" id="totalSlots">0</div>
<div class="stat-label">Total Slots</div>
</div>
<div class="stat-card">
<div class="stat-number" id="totalBookings">0</div>
<div class="stat-label">Total Bookings</div>
</div>
<div class="stat-card">
<div class="stat-number" id="activeBookings">0</div>
<div class="stat-label">Active Bookings</div>
</div>
</div>

<div class="tabs">
<button class="tab active" onclick="showTab('slots')">Manage Slots</button>
<button class="tab" onclick="showTab('bookings')">Manage Bookings</button>
<button class="tab" onclick="showTab('stats')">Statistics</button>
</div>

<div id="slots-tab" class="tab-content">
<h3>Manage Parking Slots</h3>
<button class="btn btn-primary" onclick="showAddSlotModal()">Add New Slot</button>
<div style="margin-top:20px;">
<select id="mallSelect" onchange="loadSlots()">
<option value="">Select Mall</option>
</select>
</div>
<table class="table" id="slotsTable">
<thead>
<tr>
<th>Slot Number</th>
<th>Level</th>
<th>Zone</th>
<th>Type</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div id="bookings-tab" class="tab-content" style="display:none;">
<h3>Manage Bookings</h3>
<table class="table" id="bookingsTable">
<thead>
<tr>
<th>Booking ID</th>
<th>Mall</th>
<th>Slot</th>
<th>User</th>
<th>Status</th>
<th>Date</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div id="stats-tab" class="tab-content" style="display:none;">
<h3>Mall Statistics</h3>
<div id="statsContent"></div>
</div>
</div>
</div>

<!-- Add Slot Modal -->
<div id="addSlotModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('addSlotModal')">&times;</span>
<h3>Add New Slot</h3>
<form onsubmit="addSlot(event)">
<div class="form-group">
<label>Mall:</label>
<select id="slotMall" required>
<option value="">Select Mall</option>
</select>
</div>
<div class="form-group">
<label>Slot Number:</label>
<input type="text" id="slotNumber" required>
</div>
<div class="form-group">
<label>Level:</label>
<input type="number" id="slotLevel" min="1" required>
</div>
<div class="form-group">
<label>Zone:</label>
<select id="slotZone" required>
<option value="">Select Zone</option>
<option value="A">A</option>
<option value="B">B</option>
<option value="C">C</option>
<option value="D">D</option>
</select>
</div>
<div class="form-group">
<label>Type:</label>
<select id="slotType" required>
<option value="">Select Type</option>
<option value="REGULAR">Regular</option>
<option value="HANDICAPPED">Handicapped</option>
<option value="VIP">VIP</option>
</select>
</div>
<button type="submit" class="btn btn-primary">Add Slot</button>
</form>
</div>
</div>

<script>
let currentAdmin = JSON.parse(localStorage.getItem("adminUser") || "{}");

// Check if admin is logged in
if (!currentAdmin.id) {
  window.location.href = "admin-login.html";
}

function logout() {
  localStorage.removeItem("adminUser");
  window.location.href = "admin-login.html";
}

function showTab(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  
  // Show selected tab
  document.getElementById(tabName + '-tab').style.display = 'block';
  event.target.classList.add('active');
  
  if (tabName === 'slots') loadMalls();
  if (tabName === 'bookings') loadBookings();
  if (tabName === 'stats') loadStats();
}

function loadMalls() {
  fetch("http://localhost:8080/api/malls")
    .then(res => res.json())
    .then(malls => {
      const mallSelect = document.getElementById("mallSelect");
      const slotMall = document.getElementById("slotMall");
      
      mallSelect.innerHTML = '<option value="">Select Mall</option>';
      slotMall.innerHTML = '<option value="">Select Mall</option>';
      
      malls.forEach(mall => {
        mallSelect.innerHTML += `<option value="${mall.id}">${mall.name}</option>`;
        slotMall.innerHTML += `<option value="${mall.id}">${mall.name}</option>`;
      });
    });
}

function loadSlots() {
  const mallId = document.getElementById("mallSelect").value;
  if (!mallId) return;
  
  fetch(`http://localhost:8080/api/mall-parking/slots/${mallId}`)
    .then(res => res.json())
    .then(slots => {
      const tbody = document.querySelector("#slotsTable tbody");
      tbody.innerHTML = "";
      
      slots.forEach(slot => {
        tbody.innerHTML += `
          <tr>
            <td>${slot.slotNumber}</td>
            <td>${slot.level}</td>
            <td>${slot.zone}</td>
            <td>${slot.slotType}</td>
            <td>${slot.status}</td>
            <td>
              <button class="btn btn-danger" onclick="deleteSlot(${slot.id})" ${slot.status === 'BOOKED' ? 'disabled' : ''}>Delete</button>
            </td>
          </tr>
        `;
      });
    });
}

function loadBookings() {
  fetch("http://localhost:8080/api/admin/bookings")
    .then(res => res.json())
    .then(bookings => {
      const tbody = document.querySelector("#bookingsTable tbody");
      tbody.innerHTML = "";
      
      bookings.forEach(booking => {
        tbody.innerHTML += `
          <tr>
            <td>${booking.id}</td>
            <td>${booking.mall.name}</td>
            <td>${booking.parkingSlot.slotNumber}</td>
            <td>${booking.user ? booking.user.username : 'Guest'}</td>
            <td>${booking.status}</td>
            <td>${booking.bookingDate}</td>
            <td>
              <button class="btn btn-danger" onclick="forceCancelBooking(${booking.id})">Cancel</button>
            </td>
          </tr>
        `;
      });
    });
}

function loadStats() {
  fetch("http://localhost:8080/api/malls")
    .then(res => res.json())
    .then(malls => {
      const statsContent = document.getElementById("statsContent");
      statsContent.innerHTML = "";
      
      malls.forEach(mall => {
        fetch(`http://localhost:8080/api/admin/stats/mall/${mall.id}`)
          .then(res => res.text())
          .then(stats => {
            statsContent.innerHTML += `
              <div style="background:white; padding:20px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1);">
                <h4>${mall.name}</h4>
                <p>${stats}</p>
              </div>
            `;
          });
      });
    });
}

function showAddSlotModal() {
  document.getElementById("addSlotModal").style.display = "block";
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = "none";
}

function addSlot(event) {
  event.preventDefault();
  
  const slot = {
    mall: { id: document.getElementById("slotMall").value },
    slotNumber: document.getElementById("slotNumber").value,
    level: parseInt(document.getElementById("slotLevel").value),
    zone: document.getElementById("slotZone").value,
    slotType: document.getElementById("slotType").value,
    priority: "MIDDLE",
    status: "AVAILABLE",
    rowPosition: document.getElementById("slotZone").value,
    columnPosition: 1
  };
  
  fetch("http://localhost:8080/api/admin/slots", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(slot)
  })
  .then(res => res.json())
  .then(() => {
    alert("Slot added successfully!");
    closeModal("addSlotModal");
    loadSlots();
  })
  .catch(() => alert("Failed to add slot"));
}

function deleteSlot(slotId) {
  if (confirm("Are you sure you want to delete this slot?")) {
    fetch(`http://localhost:8080/api/admin/slots/${slotId}`, {
      method: "DELETE"
    })
    .then(res => res.text())
    .then(() => {
      alert("Slot deleted successfully!");
      loadSlots();
    })
    .catch(() => alert("Failed to delete slot"));
  }
}

function forceCancelBooking(bookingId) {
  if (confirm("Are you sure you want to cancel this booking?")) {
    fetch(`http://localhost:8080/api/admin/bookings/${bookingId}`, {
      method: "DELETE"
    })
    .then(res => res.text())
    .then(() => {
      alert("Booking cancelled successfully!");
      loadBookings();
    })
    .catch(() => alert("Failed to cancel booking"));
  }
}

// Load initial data
loadMalls();
loadBookings();
</script>

</body>
</html>
